function Population(t,e,n){this.target=t,this.mutation_rate=e,this.size=n,this.population=[];for(let t=0;t<this.size;t++)NN=new NeuralNetwork(INPUT_LAYER,HIDDEN_LAYER_1,HIDDEN_LAYER_2,OUTPUT_LAYER),this.population[t]=new Game(NN);this.best_fitness,this.fitness_values=[],this.fitness_history=[],this.generation=0,this.highest_fitness=Number.MIN_SAFE_INTEGER,this.maxApplesEaten=0,this.winner=0,this.update=function(){for(let t=0;t<this.size;t++)this.population[t].update(),this.fitness_values[t]=this.population[t].fitness();isPlaying=!1;for(let t=0;t<this.size;t++)if(!this.population[t].endGame){isPlaying=!0;break}0==isPlaying&&(this.fitness_history=[...this.fitness_values])},this.getFitnessHistory=function(){return this.fitness_history},this.getBestSnakeIndex=function(){return this.fitness_values.indexOf(max(population.fitness_values))},this.drawGame=function(){population.population[best_snake].drawGame()},this.drawStatistics=function(){noStroke(),s="max apples: "+this.maxApplesEaten,text(s,RESOLUTION+10,height-RESOLUTION-10),s="highest fitness: "+this.highest_fitness,text(s,RESOLUTION+10,height-RESOLUTION-25),s="generation: "+this.generation,text(s,RESOLUTION+10,height-RESOLUTION-40)},this.updateStatistics=function(){this.best_fitness=max(this.fitness_values),this.best_fitness>this.highest_fitness&&(this.highest_fitness=this.best_fitness);for(let t=0;t<this.size;t++)apples=this.population[t].getApples(),apples>this.maxApplesEaten&&(this.maxApplesEaten=apples)},this.learningCompleted=function(){for(let t=0;t<this.size;t++)if(this.population[t].getSnakeSize()==this.target)return this.winner=t,!0;return!1},this.getWinner=function(){return this.population[this.winner].getSnake()},this.generate=function(){best_snakes=this.getBestSnakes(PERCENTAGE),probabilities=[],newPopulation=[],sum=0;for(let t=0;t<best_snakes.length;t++)sum+=best_snakes[t][0];for(let t=0;t<best_snakes.length;t++)probabilities[t]=best_snakes[t][0]/sum;for(let t=0;t<this.size;t++)parent1=this.rouletteSelection(probabilities),parent2=this.rouletteSelection(probabilities),idx1=best_snakes[parent1][1],idx2=best_snakes[parent2][1],child=this.crossover(this.population[idx1],this.population[idx2]),newPopulation[t]=new Game(child);newPopulation[this.size-1]=new Game(this.population[best_snakes[0][1]].getBrain()),newPopulation[this.size-2]=new Game(this.population[best_snakes[0][1]].getBrain()),newPopulation[this.size-3]=new Game(this.population[best_snakes[0][1]].getBrain()),this.population=newPopulation,this.generation++},this.getBestSnakes=function(t){best_snakes=[];for(let t=0;t<this.fitness_values.length;t++)best_snakes[t]=[this.fitness_values[t],t];return best_snakes=best_snakes.sort(this.sortingFunction),best_snakes=best_snakes.slice(0,floor(this.fitness_values.length*t/100)),best_snakes},this.sortingFunction=function(t,i){return t[0]==i[0]?0:t[0]>i[0]?-1:1},this.rouletteSelection=function(t){for(i=-1,p=random(1);p>0;)i++,p-=t[i];return i},this.crossover=function(t){parentBrain1=t.getBrain(),parentBrain2=t.getBrain(),childBrain=new NeuralNetwork(INPUT_LAYER,HIDDEN_LAYER_1,HIDDEN_LAYER_2,OUTPUT_LAYER);for(let t=0;t<childBrain.W.length;t++)for(let i=0;i<childBrain.W[t].length;i++)for(let s=0;s<childBrain.W[t][0].length;s++)random()<.02?childBrain.W[t][i][s]=parentBrain1.W[t][i][s]:childBrain.W[t][i][s]=parentBrain2.W[t][i][s];for(let t=0;t<childBrain.bias.length;t++)for(let i=0;i<childBrain.bias[t].length;i++)random()<.02?childBrain.bias[t][i]=parentBrain1.bias[t][i]:childBrain.bias[t][i]=parentBrain2.bias[t][i];return childBrain},this.mutate=function(){for(let t=0;t<this.size;t++){brain=this.population[t].getBrain();for(let t=0;t<brain.W.length;t++)for(let i=0;i<brain.W[t].length;i++)for(let s=0;s<brain.W[t][0].length;s++)random(1)<this.mutation_rate&&(brain.W[t][i][s]=2*random()-1);for(let t=0;t<brain.bias.length;t++)for(let i=0;i<brain.bias[t].length;i++)random(1)<this.mutation_rate&&(brain.bias[t][i]=2*random()-1)}}}